name: Nightly sync dev -> main (v0.x.0)

on:
  schedule:
    # 07:00 UTC is ~ 02:00 Montreal (EST)
    - cron: "0 7 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: nightly-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Ensure GitHub CLI is available
        run: gh --version

      - name: Check branch states
        id: guard
        run: |
          set -euo pipefail
          git fetch origin main dev

          DEV_AHEAD=$(git rev-list --count origin/main..origin/dev)
          MAIN_AHEAD=$(git rev-list --count origin/dev..origin/main)

          echo "Dev is ahead of main by: $DEV_AHEAD commits"
          echo "Main is ahead of dev by: $MAIN_AHEAD commits"

          echo "dev_ahead=$DEV_AHEAD" >> "$GITHUB_OUTPUT"
          echo "main_ahead=$MAIN_AHEAD" >> "$GITHUB_OUTPUT"

          if [ "$DEV_AHEAD" -eq 0 ] && [ "$MAIN_AHEAD" -eq 0 ]; then
            echo "Branches are perfectly in sync. Exiting."
            echo "sync_needed=false" >> "$GITHUB_OUTPUT"
          else
            echo "sync_needed=true" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Fast-forward dev if it is strictly behind main
        if: steps.guard.outputs.sync_needed == 'true' && steps.guard.outputs.dev_ahead == '0' && steps.guard.outputs.main_ahead != '0'
        run: |
          set -euo pipefail
          echo "Dev has no new code, but main has advanced. Fast-forwarding dev to match main."
          git checkout dev
          git merge origin/main --ff-only
          git push origin dev

      - name: Create or find PR from dev to main
        if: steps.guard.outputs.dev_ahead != '0'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          existing="$(gh pr list --base main --head dev --state open --json number -q '.[0].number')"
          if [ -n "$existing" ] && [ "$existing" != "null" ]; then
            echo "PR already exists: $existing"
            echo "number=$existing" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          pr_url="$(gh pr create \
            --base main \
            --head dev \
            --title "Nightly sync: dev -> main" \
            --body "Automated nightly sync from dev to main." \
            --label "nightly-sync")"

          pr_number="$(gh pr view "$pr_url" --json number -q '.number')"
          echo "Created PR: $pr_number"
          echo "number=$pr_number" >> "$GITHUB_OUTPUT"

      - name: Update PR branch (Sync main into dev)
        if: steps.guard.outputs.dev_ahead != '0' && steps.guard.outputs.main_ahead != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ steps.pr.outputs.number }}
        run: |
          set -euo pipefail
          echo "Updating PR branch for PR #$PR to include latest main."

          OLD_SHA=$(gh pr view "$PR" --json headRefOid -q '.headRefOid')

          # using the native CLI command is safer than a raw API call
          gh pr update-branch "$PR"

          echo "Polling for update completion..."
          MAX_RETRIES=15
          COUNT=0
          while [ "$COUNT" -lt "$MAX_RETRIES" ]; do
            NEW_SHA=$(gh pr view "$PR" --json headRefOid -q '.headRefOid')
            
            if [ "$NEW_SHA" != "$OLD_SHA" ]; then
              echo "Branch successfully updated! (New SHA: $NEW_SHA)"
              break
            fi
            
            echo "Waiting for GitHub backend to process the update... ($COUNT/$MAX_RETRIES)"
            sleep 2
            COUNT=$((COUNT + 1))
          done
          
          if [ "$COUNT" -eq "$MAX_RETRIES" ]; then
            echo "Error: Timed out waiting for branch update."
            exit 1
          fi

      - name: Merge PR (no auto merge)
        if: steps.guard.outputs.dev_ahead != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ steps.pr.outputs.number }}
        run: |
          set -euo pipefail
          echo "Merging PR: $PR"
          gh pr merge "$PR" --merge --admin

      - name: Tag nightly version v0.x.0
        if: steps.guard.outputs.dev_ahead != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git fetch --tags origin

          latest="$(git tag -l 'v0.*.*' --sort=-v:refname | head -n 1)"
          if [ -z "$latest" ]; then
            next="v0.1.0"
          else
            minor="$(echo "$latest" | cut -d. -f2)"
            next="v0.$((minor+1)).0"
          fi

          echo "Next nightly tag: $next"

          git fetch origin main
          git tag "$next" origin/main
          git push origin "$next"
