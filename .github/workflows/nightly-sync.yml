name: Nightly sync dev -> main (v0.x.0)

on:
  schedule:
    # 07:00 UTC is ~ 02:00 Montreal (EST)
    - cron: "0 7 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: nightly-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Ensure GitHub CLI is available
        run: gh --version

      - name: Guard - skip if dev has nothing new vs main
        id: guard
        run: |
          set -euo pipefail
          git fetch origin main dev

          counts="$(git rev-list --left-right --count origin/main...origin/dev)"
          behind="$(echo "$counts" | awk '{print $1}')"  # commits in main not in dev
          ahead="$(echo "$counts"  | awk '{print $2}')"  # commits in dev not in main

          echo "dev ahead of main by: $ahead commit(s)"
          echo "dev behind main by: $behind commit(s)"

          if [ "$ahead" -eq 0 ]; then
            echo "No new commits on dev to merge into main. Exiting."
            echo "should_merge=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_merge=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or find PR from dev to main
        if: steps.guard.outputs.should_merge == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          existing="$(gh pr list --base main --head dev --state open --json number -q '.[0].number')"
          if [ -n "$existing" ]; then
            echo "PR already exists: $existing"
            exit 0
          fi

          pr_url="$(gh pr create \
            --base main \
            --head dev \
            --title "Nightly sync: dev -> main" \
            --body "Automated nightly sync from dev to main." \
            --label "nightly-sync")"

          pr_number="$(echo "$pr_url" | sed -E 's#.*/pull/([0-9]+).*#\1#')"
          echo "Created PR: $pr_number"
          echo "number=$pr_number" >> "$GITHUB_OUTPUT"

      - name: Update PR branch to be up to date with main
        if: steps.guard.outputs.should_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR: ${{ steps.pr.outputs.number }}
        run: |
          set -euo pipefail
          echo "Updating PR branch for PR #$PR to include latest main."

          gh api -X PUT "repos/${REPO}/pulls/${PR}/update-branch" \
            -f expected_head_sha="$(gh pr view "$PR" --json headRefOid -q .headRefOid)"

      - name: Merge PR (no auto merge)
        if: steps.guard.outputs.should_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ steps.pr.outputs.number }}
        run: |
          set -euo pipefail
          echo "Merging PR: $PR"
          gh pr merge "$PR" --merge --admin

      - name: Sync dev to main after merge (keep branches aligned)
        if: steps.guard.outputs.should_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git fetch origin main dev

          git checkout -B dev origin/dev

          # bring main into dev 
          git merge origin/main --no-edit || true

          # push only if dev actually changed
          if git diff --quiet origin/dev..dev; then
            echo "dev already matches main (no sync needed)."
          else
            echo "Pushing dev to include latest main..."
            git push origin dev
          fi

      - name: Tag nightly version v0.x.0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git fetch --tags origin

          latest="$(git tag -l 'v0.*.*' --sort=-v:refname | head -n 1)"
          if [ -z "$latest" ]; then
            next="v0.1.0"
          else
            minor="$(echo "$latest" | cut -d. -f2)"
            next="v0.$((minor+1)).0"
          fi

          echo "Next nightly tag: $next"

          git checkout main
          git pull origin main

          git tag "$next"
          git push origin "$next"
